<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>IoT app with MQTT</title>
    <!-- Latest compiled and minified CSS -->  <script src="https://api.cloudmqtt.com/sso/js/jquery.min.js"></script>
      <script src="https://api.cloudmqtt.com/sso/js/bootstrap.min.js"></script>
      <script src="https://api.cloudmqtt.com/sso/js/mqttws31.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  </head>
  <body>

    <div class="container">
      <br>
      <h1 class="text text-center text-primary"> <b>IoT app</b> </h1>
      <br>
      <button type="button" class="btn btn-block btn-primary " onclick="showDiv()">Settings</button>
    </div>
    <script src = "show_hide_div.js"></script>
    <br><br><br><br>
    <div class="container" id="settings" style="display: none;">

<h5 class="text text-center">
          <div class="row">
            <div class="col-xs-6">
              <label for="serverName">Server:  </label>
              <br>
              <input type="text" name="server"   placeholder = "Enter data here....." id="serverName">
            </div>
            <div class="col-xs-6">
              <label for="portName">Port:  </label>
              <br>
              <input type="text" name="port"   placeholder = "Enter data here....." id="portName">
            </div>
            <br>
          </div>
          <div class="row">
            <br><br>
            <div class="col-xs-6">
              <label for="userName">Username:  </label>
              <br>
              <input type="text" name="username"   placeholder = "Enter data here....." id="userName">
            </div>
            <div class="col-xs-6">
              <label for="password">Password:  </label>
              <br>
              <input type="password" name="password"   placeholder = "Enter data here....." id="password">
            </div>
          </div>
          <div class="row">
            <br><br>
            <div class="col-xs-6">
              <label for="intopic">Intopic:  </label>
              <br>
              <input type="text" name="intopic"  placeholder = "Enter data here....." id="intopic">
            </div>
            <div class="col-xs-6">
              <label for="outtopic">Outtopic:  </label>
              <br>
              <input type="text" name="outtopic" placeholder = "Enter data here....." id="outtopic">
            </div>
          </div>
          <br>
          <button type="button" class="btn btn-sm btn-success " onclick="save()">Save</button>
          <button type="button" class="btn btn-sm btn-warning " onclick="reload()">Load</button>
          <button type="button" class="btn btn-sm btn-info " onclick="start()">Start</button>


</h5>


    </div>

    <div class="container" id="send_rcv" style="display: none;">
      <div class="row">
        <div class="col-xs-3">
          <br><br>
        <form id="send">
          <textarea id="message" name="message" rows="8" cols="25"></textarea>
          <br>
          <button type="submit" class="btn btn-block btn-primary ">Publish</button>
        </form>
        </div>
        <div class="col-xs-2">
          <br>
        </div>
        <div class="col-xs-6">
          <h3 class="text text-primary text-center"><b>My messages</b> </h3>
          <br>
          <pre class="pre-scrollable">
          <h7 id="messg"></h7>
        </pre>
        </div>
      </div>
      </div>
      <script src="locally_save.js"></script>
      <script>
      var server,port,username,password,intopic,outtopic;
      function save()
      {
        server = document.getElementById('serverName').value;
        port =  document.getElementById('portName').value;
        username =  document.getElementById('userName').value;
        password =  document.getElementById('password').value;
        intopic =  document.getElementById('intopic').value;
        outtopic =  document.getElementById('outtopic').value;
        localStorage.setItem("server", server);
        localStorage.setItem("port", port);
        localStorage.setItem("username", username);
        localStorage.setItem("password", password);
        localStorage.setItem("intopic", intopic);
        localStorage.setItem("outtopic", outtopic);
        window.alert("All data saved successfully!");
      }
      function reload()
      {
        window.alert("All data reloaded");
        document.getElementById('serverName').value = localStorage.getItem("server");
        document.getElementById('portName').value = localStorage.getItem("port");
        document.getElementById('userName').value = localStorage.getItem("username");
        document.getElementById('password').value = localStorage.getItem("password");
        document.getElementById('intopic').value = localStorage.getItem("intopic");
        document.getElementById('outtopic').value = localStorage.getItem("outtopic");
        server = document.getElementById('serverName').value;
        port =  document.getElementById('portName').value;
        username =  document.getElementById('userName').value;
        password =  document.getElementById('password').value;
        intopic =  document.getElementById('intopic').value;
        outtopic =  document.getElementById('outtopic').value;


      }
      function start()
      {
        server = document.getElementById('serverName').value;
        port =  document.getElementById('portName').value;
        username =  document.getElementById('userName').value;
        password =  document.getElementById('password').value;
        intopic =  document.getElementById('intopic').value;
        outtopic =  document.getElementById('outtopic').value;
        console.log("username: "+ username);
        console.log("uesrname: " + username);
        console.log("uesrname: " + username);
        console.log("port: " + port);
        console.log("server: " + server);
        console.log("password: " + password);
        document.getElementById('send_rcv').style.display = "block";
        document.getElementById('settings').style.display = "none";

        var form = document.forms["send"];
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          message = new Paho.MQTT.Message(document.getElementById("message").value);
          message.destinationName = intopic;
          client.send(message);
          client.publish(outtopic,message);

        });

        // called when the client connects
        function onConnect() {
          // Once a connection has been made, make a subscription and send a message.
          console.log("CONNECTED");
          window.alert("CONNECTED");
          client.subscribe(intopic);
        }

        // called when the client loses its connection
        function onConnectionLost(responseObject) {
          if (responseObject.errorCode !== 0) {
            console.log("onConnectionLost:", responseObject.errorMessage);
            setTimeout(function() { client.connect() }, 5000);
          }
        }

        // called when a message arrives
        function onMessageArrived(message) {
          var tdTopic = document.createElement("td");
          tdTopic.textContent = message.destinationName;
          console.log("Message destination:" + message.destinationName);
          console.log("message: " + message.payloadString);
          console.log("message dest: " + message.destinationName);

          var node = document.createElement("LI");
          var textnode = document.createTextNode(message.payloadString);
          node.appendChild(textnode);
          document.getElementById("messg").appendChild(node);
          //
          // var tdMsg = document.createElement("td");
          // try {
          //   tdMsg.textContent = message.payloadString;
          // } catch (e) {
          //   //tdMsg.textContent = "*** Binary data ***";
          //   var pre = document.createElement("pre");
          //   var base64 = btoa(String.fromCharCode.apply(null, message.payloadBytes));
          //   pre.textContent = base64.replace(/(.{72})/g, "$1\n");
          //   var note = document.createElement("em");
          //   note.textContent = "Binary data (base64 encoded)"
          //   tdMsg.appendChild(note);
          //   tdMsg.appendChild(pre)
          // }
          //
          // var tr = document.createElement("tr");
          // tr.appendChild(tdTopic);
          // tr.appendChild(tdMsg);
          // console.log("tdMsg: " + tdMsg);
          // console.log("tdTopic: " + tdTopic);
          // console.log("tr: " + tr);
          //
          // document.getElementById("msgs").appendChild(tr);
          window.alert("One new message");
        }

        function onFailure(invocationContext, errorCode, errorMessage) {
          var errDiv = document.getElementById("error");
          errDiv.textContent = "Could not connect to WebSocket server, most likely you're behind a firewall that doesn't allow outgoing connections to port 30755";
          errDiv.style.display = "block";
        }
        var clientId = "ws" + Math.random();
        // Create a client instance
        console.log("Hello, so the server is: " + server);
        console.log("The lenght of server is: " + server.length);
        port = parseInt(port);
        console.log("The amazing port is: "+ port);
        var client = new Paho.MQTT.Client(server, port , clientId);
        // set callback handlers
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        console.log("This is an amzing username: " + username);
        // connect the client
        client.connect({
          useSSL: true,
          userName: username,
          password: password,
          onSuccess: onConnect,
          onFailure: onFailure
        });
      }
      </script>
    </div>
  </body>
</html>
